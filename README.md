## **Техническое задание (ТЗ)**

### **Feed-сервис с CQRS, SSO, PostgreSQL и полной системой тестирования**

---

## **1. Цель проекта**

Разработать высоконагруженный backend-сервис ленты (feed), аналогичный Instagram/Twitter, с использованием PHP и современной backend-архитектуры.

Сервис должен:

* поддерживать CQRS (разделение чтения и записи),
* использовать PostgreSQL как основную БД (и для приложения, и для тестов),
* иметь асинхронную обработку через очередь,
* поддерживать SSO-авторизацию,
* быть полностью покрыт автотестами,
* позволять локально симулировать высокую нагрузку,
* **разворачиваться локально одной командой**.

---

## **2. Функциональные требования**

### **2.1 Пользователи**

* Аутентификация через SSO (OAuth2 / OpenID Connect)
* Поддержка нескольких провайдеров (минимум 1, например Google или GitHub)
* Создание пользователя при первом входе через SSO
* Подписка / отписка на других пользователей
* Получение персонального feed

---

### **2.2 Посты**

* Создание поста (текст)
* Лайк / анлайк поста
* Пост является immutable (редактирование не требуется)
* Все изменения проходят через Command-часть CQRS

---

### **2.3 Feed**

* Персональная лента пользователя
* Сортировка по времени (desc)
* Пагинация / infinite scroll
* Eventual consistency допускается
* Быстрая выдача данных (оптимизированная read-model)

---

## **3. Архитектурные требования**

### **3.1 CQRS**

* **Write Side**

    * Команды: `CreatePost`, `LikePost`, `FollowUser`
    * Source of truth — write-таблицы PostgreSQL
* **Events**

    * `PostCreated`, `PostLiked`, `UserFollowed`
* **Read Side**

    * Отдельная read-model для feed (`user_feed`)
    * Оптимизирована под чтение
* **Worker**

    * Асинхронно обрабатывает события
    * Обновляет read-model и кэш

---

### **3.2 База данных**

* PostgreSQL
* Используется:

    * в приложении
    * в unit / integration / e2e тестах
    * в нагрузочных сценариях
* Основные таблицы:

    * `users`
    * `posts`
    * `follows`
    * `likes`
    * `user_feed` (read-model)

---

### **3.3 Очереди**

* RabbitMQ или Kafka
* Используется для:

    * fan-out постов в feed подписчиков
    * асинхронной обработки
* Поддержка:

    * retry
    * idempotency
    * dead-letter queue

---

### **3.4 Кэш**

* Redis
* Используется для:

    * кэша feed пользователя
    * популярных постов
    * (опционально) rate limiting
* Поддержка TTL и инвалидации

---

### **3.5 Авторизация (SSO)**

* OAuth2 / OpenID Connect
* Access Token используется для авторизации API
* Возможность мокать SSO для тестов

---

## **4. Нефункциональные требования**

### **4.1 Производительность**

* Оптимизация чтения feed
* Минимизация JOIN-ов в горячих запросах
* Поддержка горизонтального масштабирования (логически)

---

### **4.2 Масштабируемость**

* Возможность симуляции:

    * 1 000 000 пользователей
    * 10 000 000 постов
    * десятков тысяч RPS
* Поддержка асинхронных операций

---

## **5. Тестирование**

### **5.1 Unit-тесты**

* Бизнес-логика команд
* Доменные сервисы
* Query-сервисы

### **5.2 Integration-тесты**

* API + PostgreSQL
* API + Redis
* API + Queue + Worker
* CQRS pipeline (Command → Event → Read-model)

### **5.3 Functional / E2E**

* SSO login → создание пользователя
* Создание поста → обновление feed подписчиков
* Получение feed через API

### **5.4 Нагрузочное тестирование**

* Генерация:

    * GET `/feed`
    * POST `/posts`
    * POST `/likes`
* Метрики:

    * RPS
    * latency (p95, p99)
    * error rate
    * queue backlog
    * cache hit/miss

---

## **6. Локальный запуск и DX (Developer Experience)**

### **6.1 Быстрый старт**

* Проект должен полностью подниматься **одной командой**
* Используется Docker + Docker Compose
* Все зависимости поднимаются автоматически:

    * PHP API
    * PostgreSQL
    * Redis
    * Queue
    * Worker
    * Load-testing сервис

---

### **6.2 Task Runner**

* Используется **Taskfile**
* Обязательные команды:

    * `task up` — поднять всю инфраструктуру
    * `task down` — остановить
    * `task test` — все тесты
    * `task test:unit`
    * `task test:integration`
    * `task test:e2e`
    * `task test:load`
    * `task seed` — загрузка тестовых / больших данных

---

### **6.3 Тесты и нагрузка в Docker**

* Все тесты должны запускаться **в контейнерах**
* PostgreSQL используется реальный (не SQLite)
* Нагрузочное тестирование:

    * запускается как отдельный Docker-контейнер
    * не требует ручной настройки
    * интегрировано в Taskfile
* Возможность запускать нагрузку против локального стенда без конфликтов

---

## **7. Tech Stack**

* PHP 8+
* Laravel или Symfony
* PostgreSQL
* Redis
* RabbitMQ или Kafka
* OAuth2 / OpenID Connect
* Docker / Docker Compose
* Taskfile
* PHPUnit или Pest
* k6 или JMeter (в Docker)

---

## **8. Результат**

В результате должен быть получен:

* полностью рабочий feed-сервис,
* с CQRS и асинхронной архитектурой,
* SSO-авторизацией,
* полной системой автотестов,
* возможностью локально симулировать высокую нагрузку,
* удобным запуском и тестированием одной командой.

---
